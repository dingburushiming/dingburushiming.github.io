<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringCloud学习笔记 | 定不辱使命</title><meta name="description" content="SpringCloud学习笔记"><meta name="author" content="李上"><meta name="copyright" content="李上"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringCloud学习笔记"><meta name="twitter:description" content="SpringCloud学习笔记"><meta name="twitter:image" content="http://yoursite.com/img/springcloud.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud学习笔记"><meta property="og:url" content="http://yoursite.com/2020/07/21/springcloud/"><meta property="og:site_name" content="定不辱使命"><meta property="og:description" content="SpringCloud学习笔记"><meta property="og:image" content="http://yoursite.com/img/springcloud.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css" ><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/07/21/springcloud/"><link rel="prev" title="HashMap源码分析" href="http://yoursite.com/2020/07/28/hashmap/"><link rel="next" title="数据库中间件" href="http://yoursite.com/2020/07/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">52</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#服务注册中心"><span class="toc-number">1.</span> <span class="toc-text">服务注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka"><span class="toc-number">1.1.</span> <span class="toc-text">Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自我保护"><span class="toc-number">1.1.1.</span> <span class="toc-text">自我保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper"><span class="toc-number">1.2.</span> <span class="toc-text">ZooKeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consul"><span class="toc-number">1.3.</span> <span class="toc-text">Consul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">1.3.1.</span> <span class="toc-text">安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三个注册中心的异同点"><span class="toc-number">1.4.</span> <span class="toc-text">三个注册中心的异同点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP"><span class="toc-number">1.4.1.</span> <span class="toc-text">CAP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ribbon负载均衡服务调用"><span class="toc-number">2.</span> <span class="toc-text">Ribbon负载均衡服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LB负载均衡"><span class="toc-number">2.0.1.</span> <span class="toc-text">LB负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#集中式LB"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">集中式LB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#进程内LB"><span class="toc-number">2.0.1.2.</span> <span class="toc-text">进程内LB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ribbon"><span class="toc-number">2.0.1.3.</span> <span class="toc-text">Ribbon</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon负载规则替换"><span class="toc-number">2.0.2.</span> <span class="toc-text">Ribbon负载规则替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon负载均衡算法"><span class="toc-number">2.0.3.</span> <span class="toc-text">Ribbon负载均衡算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign服务调用"><span class="toc-number">3.</span> <span class="toc-text">OpenFeign服务调用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hystrix服务降级"><span class="toc-number">4.</span> <span class="toc-text">Hystrix服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务雪崩"><span class="toc-number">4.1.</span> <span class="toc-text">服务雪崩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重要概念"><span class="toc-number">4.2.</span> <span class="toc-text">重要概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务降级fallback"><span class="toc-number">4.2.1.</span> <span class="toc-text">服务降级fallback</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#会导致服务降级的情况"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">会导致服务降级的情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务熔断break"><span class="toc-number">4.2.2.</span> <span class="toc-text">服务熔断break</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务限流flowlimit"><span class="toc-number">4.2.3.</span> <span class="toc-text">服务限流flowlimit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用方法"><span class="toc-number">4.3.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务降级"><span class="toc-number">4.3.1.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务熔断"><span class="toc-number">4.3.2.</span> <span class="toc-text">服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#涉及到断路器的三个重要参数"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">涉及到断路器的三个重要参数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务网关Gateway"><span class="toc-number">5.</span> <span class="toc-text">服务网关Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#三大核心概念"><span class="toc-number">5.1.</span> <span class="toc-text">三大核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Route路由"><span class="toc-number">5.1.1.</span> <span class="toc-text">Route路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Predicate断言"><span class="toc-number">5.1.2.</span> <span class="toc-text">Predicate断言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter过滤"><span class="toc-number">5.1.3.</span> <span class="toc-text">Filter过滤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作流程"><span class="toc-number">5.2.</span> <span class="toc-text">工作流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-Config分布式配置中心"><span class="toc-number">6.</span> <span class="toc-text">SpringCloud Config分布式配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#功能"><span class="toc-number">6.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#规则"><span class="toc-number">6.2.</span> <span class="toc-text">规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lable-name-profile-yml"><span class="toc-number">6.2.1.</span> <span class="toc-text">&#x2F;{lable}&#x2F;{name}-{profile}.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#name-profile-yml"><span class="toc-number">6.2.2.</span> <span class="toc-text">&#x2F;{name}-{profile}.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#name-profile-label"><span class="toc-number">6.2.3.</span> <span class="toc-text">&#x2F;{name}&#x2F;{profile}[&#x2F;{label}]</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用户端配置与测试"><span class="toc-number">6.3.</span> <span class="toc-text">用户端配置与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动态刷新"><span class="toc-number">6.3.1.</span> <span class="toc-text">动态刷新</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息总线BUS"><span class="toc-number">7.</span> <span class="toc-text">消息总线BUS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是总线"><span class="toc-number">7.1.</span> <span class="toc-text">什么是总线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本原理"><span class="toc-number">7.2.</span> <span class="toc-text">基本原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream消息驱动"><span class="toc-number">8.</span> <span class="toc-text">Stream消息驱动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sleuth分布式请求链路跟踪"><span class="toc-number">9.</span> <span class="toc-text">Sleuth分布式请求链路跟踪</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos"><span class="toc-number">9.1.</span> <span class="toc-text">Nacos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos命名空间"><span class="toc-number">9.2.</span> <span class="toc-text">Nacos命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DataID配置"><span class="toc-number">9.3.</span> <span class="toc-text">DataID配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Namespace方案"><span class="toc-number">9.4.</span> <span class="toc-text">Namespace方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos集群和持久化"><span class="toc-number">9.5.</span> <span class="toc-text">Nacos集群和持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel实现熔断与限流"><span class="toc-number">9.6.</span> <span class="toc-text">Sentinel实现熔断与限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流控规则"><span class="toc-number">9.6.1.</span> <span class="toc-text">流控规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#降级规则"><span class="toc-number">9.6.2.</span> <span class="toc-text">降级规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RT-秒级平均响应时间"><span class="toc-number">9.6.2.1.</span> <span class="toc-text">RT:秒级平均响应时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常比例-秒级"><span class="toc-number">9.6.2.2.</span> <span class="toc-text">异常比例:秒级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常数-分钟级"><span class="toc-number">9.6.2.3.</span> <span class="toc-text">异常数:分钟级</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#热点key限流"><span class="toc-number">9.7.</span> <span class="toc-text">热点key限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参数列外项"><span class="toc-number">9.7.1.</span> <span class="toc-text">参数列外项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系统规则"><span class="toc-number">9.8.</span> <span class="toc-text">系统规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SentinelResource"><span class="toc-number">9.9.</span> <span class="toc-text">@SentinelResource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel持久化规则"><span class="toc-number">9.10.</span> <span class="toc-text">Sentinel持久化规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式事务的由来"><span class="toc-number">9.11.</span> <span class="toc-text">分布式事务的由来</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概念"><span class="toc-number">9.11.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SEATA的分布式交易解决方案"><span class="toc-number">9.11.2.</span> <span class="toc-text">SEATA的分布式交易解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#原理"><span class="toc-number">9.11.2.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AT模式"><span class="toc-number">9.11.2.1.1.</span> <span class="toc-text">AT模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#整体机制"><span class="toc-number">9.11.2.1.2.</span> <span class="toc-text">整体机制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#一阶段"><span class="toc-number">9.11.2.1.2.1.</span> <span class="toc-text">一阶段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#二阶段"><span class="toc-number">9.11.2.1.2.2.</span> <span class="toc-text">二阶段</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/springcloud.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">定不辱使命</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">SpringCloud学习笔记</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-21 10:02:11"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-07-21</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-08-14 14:45:13"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-08-14</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>SpringCloud版本采用了名称而非版本号的命名，这些版本的名字采用了伦敦地铁站的名字，根据字母表的顺序来对应版本的时间顺序，SpringBoot与SpringCloud之间有严格的对应关系</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/001.png"  alt="springcloud"></p>
<p>Maven使用dependencyManagement元素来提供了一种管理依赖版本号的方式，使用pom.xml中的dependencyManagement元素能让所有在子项目中引用一个依赖而不用显式地列出版本号。Maven会沿着父子层次向上走，直到找到一个拥有dependencyManagement元素的项目，然后它就会使用这个dependencyManagement元素中指定的版本号</p>
<p>dependencyManagement只是声明依赖，并不实现引入，因此子项目需要显式地声明需要用的依赖</p>
<h1 id="服务注册中心"><a href="#服务注册中心" class="headerlink" title="服务注册中心"></a>服务注册中心</h1><p>Eureka采用CS设计架构，Eureka Server作为服务注册功能的服务器，是服务注册中心，使用Eureka的客户端连接到Eureka Server并维持心跳连接，维护人员可以通过Eureka Server来监控系统中的各个微服务是否正常运行</p>
<p>EurekaClient会向Eureka  Server发送心跳(默认周期为30s),如果Eureka  Server在多个心跳周期内没有接收到某个节点的心跳，Eureka  Server将会从服务注册表中将这个服务节点移除</p>
<p>服务注册：将服务信息注册进注册中心</p>
<p>服务发现：从注册中心上获取服务信息</p>
<p>服务的注册发现本质上是存key服务，取value调用地址</p>
<p>Eureka与Dubbo的架构对比图</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/003.png"  alt="springcloud"></p>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><p>Spring Cloud封装了Netflix公司开发的Eureka模块来实现服务治理</p>
<p>消费者获得服务地址后，底层实际是利用HttpClient技术实现远程调用，消费者获得服务地址后会缓存在本地jvm内存中，默认每间隔30秒更新一次服务调用地址</p>
<p>注册中心不能只有一个，需要搭建Eureka注册中心集群，实现负载均衡+故障容错</p>
<p>集群的本质是互相注册，相互守望</p>
<h3 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h3><p>为了防止EurekaClient可以正常运行，但是与EurekaServer网络不通的情况下，EurekaServer不会立即将EurekaClient服务剔除</p>
<h2 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h2><p>微服务没有按时发送心跳包给zookeeper，zookeeper会直接将该微服务剔除</p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><ol>
<li>服务发现提供HTTP和DNS两种发现方式；</li>
<li>健康监测支持多种方式；</li>
<li>HTTP,TCP,Docker,Shell脚本定制化；KV键值对存储方式；</li>
<li>consul支持多数据中心；</li>
<li>可视化界面</li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>consul agent -dev使用开发者模式启动</li>
<li>可以通过<a href="http://localhost:8500查看页面">http://localhost:8500查看页面</a></li>
</ol>
<h2 id="三个注册中心的异同点"><a href="#三个注册中心的异同点" class="headerlink" title="三个注册中心的异同点"></a>三个注册中心的异同点</h2><h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><p>C:Consistency 强一致性，即数据库的数据的准确性，延迟准确</p>
<p>A:Availability 可用性</p>
<p>P:Partition tolerance 分区容错性，必须要满足</p>
<table>
<thead>
<tr>
<th>Eureka</th>
<th>Java</th>
<th>AP</th>
</tr>
</thead>
<tbody><tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
</tr>
</tbody></table>
<p>Eureka保证高可用性，微服务停止也不立即剔除；Consul和Zookeeper保证强一致性，一旦微服务停止立即剔除。三者都必须满足P分区容错性</p>
<h1 id="Ribbon负载均衡服务调用"><a href="#Ribbon负载均衡服务调用" class="headerlink" title="Ribbon负载均衡服务调用"></a>Ribbon负载均衡服务调用</h1><p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端负载均衡工具</p>
<p>Ribbon客户端组件提供一系列完成的配置项如连接超时，重试等</p>
<h3 id="LB负载均衡"><a href="#LB负载均衡" class="headerlink" title="LB负载均衡"></a>LB负载均衡</h3><p>将用户请求平摊的分配到多个服务上，从而达到系统高可用</p>
<p>常用的负载均衡有软件Nginx，LVS，硬件F5等</p>
<h4 id="集中式LB"><a href="#集中式LB" class="headerlink" title="集中式LB"></a>集中式LB</h4><p>Nginx是服务器负载均衡，客户端所有请求都会交给Nginx,然后由nginx实现转发请求，即负载均衡是由服务端实现的</p>
<h4 id="进程内LB"><a href="#进程内LB" class="headerlink" title="进程内LB"></a>进程内LB</h4><p>Ribbon本地负载均衡，在调用微服务接口时候，会在注册中心上获取注册信息服务列表之后缓存到本地JVM,从而在本地实现RPC远程服务调用技术</p>
<h4 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h4><p>选择EurekaServer,它优先选择在同一个区域内负载较少的Server</p>
<p>Ribbon其实是一个软负载均衡的客户端组件，可以和其他所需请求的客户端结合使用，和Eureka结合只是其中的一个实例</p>
<p>最新的Eureka依赖内置了Ribbon</p>
<h3 id="Ribbon负载规则替换"><a href="#Ribbon负载规则替换" class="headerlink" title="Ribbon负载规则替换"></a>Ribbon负载规则替换</h3><p>这个配置类不能放在@ComponentScan所扫描的当前包下以及子包下，否则自定义的配置类就会被所有的Ribbon客户端所共享，达不到特殊化定制的目的了 </p>
<h3 id="Ribbon负载均衡算法"><a href="#Ribbon负载均衡算法" class="headerlink" title="Ribbon负载均衡算法"></a>Ribbon负载均衡算法</h3><p>rest接口第几次请求数%服务器集群总数量=实际调用服务器位置下标，每次服务重启后rest接口计数从1开始</p>
<h1 id="OpenFeign服务调用"><a href="#OpenFeign服务调用" class="headerlink" title="OpenFeign服务调用"></a>OpenFeign服务调用</h1><p>Feign是一个声明式WebService客户端，使用Feign能让编写Web Service客户端更加简单</p>
<p>它的使用是定义一个服务接口然后在上面添加注解，Fegin也支持可插拔式的编码器和解码器。Spring Cloud对Feign进行了封装，使其支持了Spring MVC标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用以支持负载均衡</p>
<p>Feign旨在使编写Java HTTP客户端变得更容易，前面在使用Ribbon+RestTemplate时，利用RestTemplate对http请求的封装处理，形成了一套模板化的调用方法。但在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多出调用，所以通常都会针对每个微服务自行封装一些客户端来包装，我们只需创建一个接口并使用注解的方式来配置它，即可完成对服务提供方的接口绑定，简化了使用Spring cloud Ribbon时，自动封装服务调用客户端的开发量</p>
<p>Feign封装了Ribbon，利用Ribbon维护了Payment的服务列表，并且通过轮询实现了客户端的负载均衡，而与Ribbon不同的是，通过feign只需要定义服务绑定接口且以声明式的方法，优雅而简单的实现了服务调用</p>
<h1 id="Hystrix服务降级"><a href="#Hystrix服务降级" class="headerlink" title="Hystrix服务降级"></a>Hystrix服务降级</h1><h2 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h2><p>多个微服务之间的调用，假设微服务A调用微服务B和微服务C,微服务B和微服务C又调用其他的微服务，这就是所谓的扇出，如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的的雪崩效应，级联故障</p>
<p>Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时，异常等。Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性</p>
<p>断路器本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控(类似熔断保险丝)，向调用方返回一个符合预期的，可处理的备选响应，而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间，不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩</p>
<h2 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h2><h3 id="服务降级fallback"><a href="#服务降级fallback" class="headerlink" title="服务降级fallback"></a>服务降级fallback</h3><p>服务器忙，请稍后再试，不让客户端等待并立即返回一个友好提示</p>
<h4 id="会导致服务降级的情况"><a href="#会导致服务降级的情况" class="headerlink" title="会导致服务降级的情况"></a>会导致服务降级的情况</h4><ol>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断触发服务降级</li>
<li>线程池/信号量打满也会导致服务降级</li>
</ol>
<h3 id="服务熔断break"><a href="#服务熔断break" class="headerlink" title="服务熔断break"></a>服务熔断break</h3><p>达到最大服务访问后，直接拒绝访问，然后调用服务降级的方法并返回友好提示</p>
<p>当扇出链路的某个微服务出错不可用或者响应时间太长，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息</p>
<p>当检测到该节点微服务调用响应正常后，恢复调用链路</p>
<p>当失败的调用达到一定的阈值，缺少是5秒内20次调用失败，就会启动熔断机制，熔断机制的注解是@HystrixCommand</p>
<h3 id="服务限流flowlimit"><a href="#服务限流flowlimit" class="headerlink" title="服务限流flowlimit"></a>服务限流flowlimit</h3><p>秒杀高并发操作，严禁一窝蜂得过来拥挤，大家排队，一秒钟N个,有序进行</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p>当高并发请求打到一个请求时，除了这个请求会变慢以外，当前微服务的其他方法也会被拖慢</p>
<p>一旦调用服务方法失败并抛出了错误信息后，会自动调用@HystrixCommand标准好的fallbackMethod调用类中的指定方法</p>
<p>主启动类中添加@EnableCircuitBreaker注解</p>
<p>服务降级fallback一般用在客户端</p>
<p>通用的和独享的服务降级方法分开，避免代码膨胀，合理减少代码量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@DefaultProperties(defaultFallback &#x3D; &quot;payment_Global_FallbackMethod&quot;)</span><br><span class="line">public class OrderHystirxController</span><br><span class="line">&#123;</span><br><span class="line">    @Resource</span><br><span class="line">    private PaymentHystrixService paymentHystrixService;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;&#x2F;consumer&#x2F;payment&#x2F;hystrix&#x2F;ok&#x2F;&#123;id&#125;&quot;)</span><br><span class="line">    public String paymentInfo_OK(@PathVariable(&quot;id&quot;) Integer id)</span><br><span class="line">    &#123;</span><br><span class="line">        String result &#x3D; paymentHystrixService.paymentInfo_OK(id);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;consumer&#x2F;payment&#x2F;hystrix&#x2F;timeout&#x2F;&#123;id&#125;&quot;)</span><br><span class="line">    @HystrixCommand(fallbackMethod &#x3D; &quot;paymentTimeOutFallbackMethod&quot;,commandProperties &#x3D; &#123;    @HystrixProperty(name&#x3D;&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value&#x3D;&quot;1500&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    public String paymentInfo_TimeOut(@PathVariable(&quot;id&quot;) Integer id)</span><br><span class="line">    &#123;</span><br><span class="line">        int age &#x3D; 10&#x2F;0;</span><br><span class="line">        String result &#x3D; paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String paymentTimeOutFallbackMethod(@PathVariable(&quot;id&quot;) Integer id)</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,o(╥﹏╥)o&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 下面是全局fallback方法</span><br><span class="line">    public String payment_Global_FallbackMethod()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;Global异常处理信息，请稍后再试，&#x2F;(ㄒoㄒ)&#x2F;~~&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h3><p>过程：服务降级—&gt;熔断—&gt;恢复调用链路</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/004.png"  alt="springcloud"></p>
<h4 id="涉及到断路器的三个重要参数"><a href="#涉及到断路器的三个重要参数" class="headerlink" title="涉及到断路器的三个重要参数"></a>涉及到断路器的三个重要参数</h4><ol>
<li><p>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒</p>
</li>
<li><p>请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认值为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或者其他原因失败，断路器都不会打开</p>
</li>
<li><p>错误百分比阈值：当请求总数在快照时间窗内超过了阈值，且失败率超过了设置的错误百分比，那么就会触发断路器</p>
<p>一段时间之后(默认是5秒)，这个时候断路器是半开状态，会让其中一个请求进行转发，如果成功，断路器会关闭，若失败，则接着处于断开状态</p>
</li>
</ol>
<h1 id="服务网关Gateway"><a href="#服务网关Gateway" class="headerlink" title="服务网关Gateway"></a>服务网关Gateway</h1><p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/005.png"  alt="springcloud"></p>
<p>Gateway是原zuul1.x版的替代品，SpringCloud Gateway作为SpringCloud生态系统中的网关，目标是替代Zuul，Zuul1.x是基于Servet的一个阻塞式处理模型</p>
<p>SpringCloud Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty,是基于异步非阻塞模型上进行开发的，性能很好还支持WebSocket,并且与Spring紧密集成拥有更好的开发体验</p>
<p>传统的Web框架，例如struct2,springmvc等都是基于Servlet API与Servlet容器基础之上运行的，在Servlet3.1之后有了异步非阻塞的支持，而WebFlux是一个典型非阻塞异步的框架，它的核心是基于Reactor的相关API实现的，相对于传统的web框架而言，它可以运行在诸如Netty,Undertow及支持Servlet3.1的容器上。</p>
<p>Spring WebFlux是Spring5.0引入的新的响应式框架，区别于Spring MVC，它不需要依赖Servlet API,它是完全异步非阻塞的，并且基于Reactor来实现响应式流规范</p>
<h2 id="三大核心概念"><a href="#三大核心概念" class="headerlink" title="三大核心概念"></a>三大核心概念</h2><h3 id="Route路由"><a href="#Route路由" class="headerlink" title="Route路由"></a>Route路由</h3><p>路由是构建网关的基本模块，它由ID,目标URL,一系列的断言和过滤器组成</p>
<h3 id="Predicate断言"><a href="#Predicate断言" class="headerlink" title="Predicate断言"></a>Predicate断言</h3><p>如果请求与断言相匹配则进行路由</p>
<h3 id="Filter过滤"><a href="#Filter过滤" class="headerlink" title="Filter过滤"></a>Filter过滤</h3><p>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由之前或者之后对请求进行修改</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>客户端向Spring Cloud Gateway发出请求，然后Gateway Handler Mapping中找到与请求相匹配的路由，将其发送到Gateway Web Handler</p>
<p>Handler再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前pre或之后post执行业务逻辑</p>
<p>Filter在pre类型的过滤器可以做参数校验，权限校验，流量监控，日志输出，协议转换等。在post类型的过滤器中可以做响应内容，响应头的修改，日志的输出，流量监控等有着非常重要的作用 </p>
<p>默认情况下Gateway会根据注册中心注册的服务列表，以注册中心上微服务名为路径创建动态路由进行转发，从而实现动态路由的功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9527</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cloud-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true #开启从注册中心动态创建路由的功能，利用微服务名进行路由</span><br><span class="line">      routes:</span><br><span class="line">        - id: payment_routh                    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="line">#          uri: http:&#x2F;&#x2F;localhost:8001          #匹配后提供服务的路由地址</span><br><span class="line">          uri: lb:&#x2F;&#x2F;cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="line">          predicates:</span><br><span class="line">            - Path&#x3D;&#x2F;payment&#x2F;get&#x2F;**         # 断言，路径相匹配的进行路由</span><br><span class="line"></span><br><span class="line">        - id: payment_routh2              #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="line">#          uri: http:&#x2F;&#x2F;localhost:8001          #匹配后提供服务的路由地址</span><br><span class="line">          uri: lb:&#x2F;&#x2F;cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="line">          predicates:</span><br><span class="line">            - Path&#x3D;&#x2F;payment&#x2F;lb&#x2F;**         # 断言，路径相匹配的进行路由</span><br><span class="line">            - After&#x3D;2020-08-21T15:51:37.485+08:00[Asia&#x2F;Shanghai]</span><br><span class="line">            - Cookie&#x3D;username,zzyy</span><br><span class="line">            - Header&#x3D;X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span><br></pre></td></tr></table></figure>

<h1 id="SpringCloud-Config分布式配置中心"><a href="#SpringCloud-Config分布式配置中心" class="headerlink" title="SpringCloud Config分布式配置中心"></a>SpringCloud Config分布式配置中心</h1><p>由于每个微服务都需要必要的配置信息才能运行，所以一套集中式的，动态的配置管理设施是必不可少的</p>
<p>SpringCloud Config分为服务端和客户端两部分</p>
<p>服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密解密信息等访问接口</p>
<p>客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ol>
<li>集中管理配置文件</li>
<li>不同环境不同配置，动态化的配置更新，分环境部署比如dev/test/prod/beta/release</li>
<li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li>
<li>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置</li>
<li>将配置信息以REST接口的形式暴露</li>
</ol>
<h2 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h2><p>通过以下几种方式都可以github上的配置文件，label表示分支，name表示服务名，profiles表示环境(dev/test/prod)</p>
<h3 id="lable-name-profile-yml"><a href="#lable-name-profile-yml" class="headerlink" title="/{lable}/{name}-{profile}.yml"></a>/{lable}/{name}-{profile}.yml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:3344&#x2F;master&#x2F;config-dev.yml</span><br></pre></td></tr></table></figure>

<h3 id="name-profile-yml"><a href="#name-profile-yml" class="headerlink" title="/{name}-{profile}.yml"></a>/{name}-{profile}.yml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:3344&#x2F;config-dev.yml</span><br></pre></td></tr></table></figure>

<h3 id="name-profile-label"><a href="#name-profile-label" class="headerlink" title="/{name}/{profile}[/{label}]"></a>/{name}/{profile}[/{label}]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:3344&#x2F;config&#x2F;dev&#x2F;master</span><br></pre></td></tr></table></figure>

<h2 id="用户端配置与测试"><a href="#用户端配置与测试" class="headerlink" title="用户端配置与测试"></a>用户端配置与测试</h2><p>application.yml是用户级的资源配置项，bootstrap.yml是系统级的，优先级更高</p>
<p>SpringCloud会创建一个Bootstrap Context作为Spring应用的ApplicationContext的父上下文，初始化的时候，BootstrapContext负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的Environment</p>
<p>Bootstrap属性有高优先级，默认情况下，它们不会被本地配置覆盖。Bootstrap Context和Application Context有着不同的约定，所以增加了一个bootstrap.yml文件，保证Bootstrap Context和Application Context配置的分离</p>
<p>要将Client模块下的application.yml文件改为bootstrap.yml。这很关键，因为bootstrap.yml是比application.yml先加载的，后者的优先级高于前者</p>
<h3 id="动态刷新"><a href="#动态刷新" class="headerlink" title="动态刷新"></a>动态刷新</h3><p>1.在类上添加@RefreshScope</p>
<p>2.在配置文件中设置暴露端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 暴露监控端点</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &quot;*&quot;</span><br></pre></td></tr></table></figure>

<p>3.使用curl -X POST “<a href="http://localhost:3355/actuator/refresh&quot;属性配置" target="_blank" rel="noopener">http://localhost:3355/actuator/refresh&quot;属性配置</a></p>
<h1 id="消息总线BUS"><a href="#消息总线BUS" class="headerlink" title="消息总线BUS"></a>消息总线BUS</h1><p>SpringCloud Bus配合Spring Cloud Config使用可以实现配置的动态刷新</p>
<p>SpringCloud Bus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，它整合了Java的时间处理机制和消息中间件的功能，SpringCloud Bus目前支持RabbitMQ和Kafka</p>
<h2 id="什么是总线"><a href="#什么是总线" class="headerlink" title="什么是总线"></a>什么是总线</h2><p>在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中所有的微服务实例都连接上来，由于该主题中产生的消息会被所有实例监听和消费，所以称它为消息总线，在总线上的各个实例，都可以方便地广播一些需要让其他连接在该主题上的实例都知道的消息</p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>Config Client实例都监听MQ中同一个topic(默认是Spring Cloud Bus),当一个服务器刷新数据的时候，它会把这个信息放入到topic中，这样其他监听同一个topic的服务就能得到通知，然后去更新自身的配置</p>
<h1 id="Stream消息驱动"><a href="#Stream消息驱动" class="headerlink" title="Stream消息驱动"></a>Stream消息驱动</h1><p>屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型</p>
<p>Spring Cloud Stream是一个构建消息驱动微服务框架</p>
<p>应用程序通过inputs或者outputs来与stream的binder对象交互，我们只需要搞清楚如何与stream交互就可以方便地使用消息驱动的方式</p>
<p>目前仅支持RabbitMQ，Kafka</p>
<h1 id="Sleuth分布式请求链路跟踪"><a href="#Sleuth分布式请求链路跟踪" class="headerlink" title="Sleuth分布式请求链路跟踪"></a>Sleuth分布式请求链路跟踪</h1><h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p>Dynamic Naming  and Configuration Service</p>
<p>一个更易于构建云原生应用的动态服务发现，配置管理和服务管理平台,就是注册中心+配置中心的组合</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/006.png"  alt="springcloud"></p>
<p>Nacos同springcloud-config一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动</p>
<p>springboot中配置文件的加载是存在优先级顺序的，bootstrap优先级高于application</p>
<h2 id="Nacos命名空间"><a href="#Nacos命名空间" class="headerlink" title="Nacos命名空间"></a>Nacos命名空间</h2><p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/007.png"  alt="springcloud"></p>
<p>类似于Java里面的package名和类名，最外层的namespace是可以用于区分部署环境的，Group和DataID逻辑上区分两个目标对象</p>
<p>默认情况下，Namespace=public,Group=DEFAULT,默认Cluster是DEFAULT</p>
<p>Nacos默认的命令空间是public,Namespace主要用来实现隔离，例如现在有三个环境：开发，测试，生成环境，我们就可以创建三个Namespace，不同的Namespace之间是隔离的</p>
<p>Group默认是DEFAULT_GROUP，Group可以把不同的微服务划分到同一个分组里面去</p>
<p>Service就是微服务，一个Servie可以包含多个Cluster集群，Nacos默认Cluster是DEFAULT，Cluster是对指定微服务的一个虚拟划分。例如容灾，将Service微服务分别部署在杭州计方和广州机房，这时就可以给杭州机房的Service微服务起一个集群名字HZ,给广州机房的Service微服务起一个集群名称GZ,还可以尽量让同一个机房的微服务互相调用，以提升性能</p>
<p>最后是Instance，就是微服务的实例</p>
<h2 id="DataID配置"><a href="#DataID配置" class="headerlink" title="DataID配置"></a>DataID配置</h2><p>指定spring.profile.active和配置文件的DataID来使不同环境下读取不同的配置</p>
<h2 id="Namespace方案"><a href="#Namespace方案" class="headerlink" title="Namespace方案"></a>Namespace方案</h2><h2 id="Nacos集群和持久化"><a href="#Nacos集群和持久化" class="headerlink" title="Nacos集群和持久化"></a>Nacos集群和持久化</h2><p>默认的Nacos使用嵌入式数据库实现数据的存储，如果启动多个默认配置下的Nacos节点，数据存储是存在一致性问题的，为了解决这个问题，Nacos采用了集中式存储的方式来支持集群化部署，目前只支持MySQL的存储</p>
<p>单机模式用于测试和单机使用；集群模式用于生产环境，确保高可用；多集群模式用于数据中心场景</p>
<p>zip压缩文件是windows文件，tar.gz压缩文件是Linux文件</p>
<p>linux是执行sh文件，windows是执行cmd文件</p>
<h2 id="Sentinel实现熔断与限流"><a href="#Sentinel实现熔断与限流" class="headerlink" title="Sentinel实现熔断与限流"></a>Sentinel实现熔断与限流</h2><p>Hystrix需要程序员自己手工搭建监控平台，没有一套web界面可以进行更加细粒度的配置流控，速率控制，服务熔断，服务降级</p>
<p>sentinel是单独一个组件，可以独立出来，直接界面化的细粒度统一配置</p>
<p>需要jdk8环境，默认端口是8080，通过命令java -jar sentinel-dashboard-1.7.0.jar启动</p>
<h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><ul>
<li><p>资源名：唯一名称，默认请求路径</p>
</li>
<li><p>针对来源：sentinel可以针对调用者进行限流，填写微服务名，默认default(不区分来源)</p>
</li>
<li><p>阈值类型/单机阈值</p>
</li>
</ul>
<ol>
<li>QPS:每秒钟的请求数量，当调用该api的QPS达到阈值的时候，进行限流</li>
<li>线程数：当调用该api的线程数达到阈值的时候，进行限流</li>
</ol>
<ul>
<li>流控模式</li>
</ul>
<ol>
<li>直接：api达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值时，就限流自己</li>
<li>链路：只记录指定链路上的流量(指定资源从入口资源进来的流量，如果达到阈值，就进行限流)[api级别的针对来源]</li>
</ol>
<ul>
<li>流控效果</li>
</ul>
<ol>
<li>快速失败：直接失败，抛异常</li>
<li>Warm Up:根据codeFactor(冷加载因子，默认3)，从阈值/codeFactor，经过预热时长，才达到设置的QPS阈值，即请求QPS从threshold/3开始，经预热时长逐渐升至设定的QPS阈值</li>
<li>排队等候：大量请求过来的时候，排队一个个的按顺序执行</li>
</ol>
<h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h3><p>sentinel熔断降级会在调用链路中某个资源出现不稳定状态时(例如调用超时或者异常比例升高)，对这个资源的调用进行限制，让请求快速失败，避免影响到其他的资源而导致级联错误</p>
<p>当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断(默认行为是抛出DegradeException)</p>
<p>Sentinel的断路器是没有半开状态的</p>
<h4 id="RT-秒级平均响应时间"><a href="#RT-秒级平均响应时间" class="headerlink" title="RT:秒级平均响应时间"></a>RT:秒级平均响应时间</h4><p>平均响应时间，超过阈值且在时间窗口内通过的请求&gt;=5,两个条件同时满足后触发降级</p>
<p>窗口期过后关闭断路器</p>
<p>RT最大4900，更大的需要通过-Dcsp.sentinel.statistic.max.rt=xxxx才能生效</p>
<h4 id="异常比例-秒级"><a href="#异常比例-秒级" class="headerlink" title="异常比例:秒级"></a>异常比例:秒级</h4><p>QPS &gt;=5且异常比例(秒级统计)超过阈值时，触发降级，时间窗口结束后，关闭降级</p>
<h4 id="异常数-分钟级"><a href="#异常数-分钟级" class="headerlink" title="异常数:分钟级"></a>异常数:分钟级</h4><p>异常数(分钟统计)超过阈值时，触发降级，时间窗口结束后，关闭降级</p>
<p>时间窗口一定要大于60s</p>
<h2 id="热点key限流"><a href="#热点key限流" class="headerlink" title="热点key限流"></a>热点key限流</h2><p>热点即经常访问的数据，很多时候我们希望统计某个热点数据中访问频次最高的TOP K数据，并对其访问进行限制，例如</p>
<ul>
<li>商品ID为参数，统计一段时间内最常购买的商品ID并进行限制</li>
<li>用户ID为参数，针对一段时间内频繁访问的用户ID进行限制</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/008.png"  alt="springcloud"></p>
<p>对访问路径的参数进行限制</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/009.png"  alt="springcloud"></p>
<h3 id="参数列外项"><a href="#参数列外项" class="headerlink" title="参数列外项"></a>参数列外项</h3><p>当参数p是某个特殊值的时候，它的限流值和平时不一样</p>
<h2 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a>系统规则</h2><ul>
<li>Load自适应(仅对Linux/Unix-like机器生效)：系统的load1作为启发指标，进行自适应系统保护，当系统load1超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护</li>
<li>CPU usage：当系统CPU使用率超过阈值即触发系统保护(取值范围0.0-1.0)，比较灵活</li>
<li>平均RT：当单台机器上所有入口流量的平均RT达到阈值即触发系统保护，单位是毫秒</li>
<li>并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护</li>
<li>入口QPS：当单台机器上所有入口流量的QPS达到阈值即触发系统保护</li>
</ul>
<h2 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h2><p>注解方法埋点不支持private方法</p>
<p>用于定义资源，并提供可选的异常处理和fallback配置项</p>
<p>Sentinel主要有三个核心api，SphU定义资源，Tracer定义统计，ContextUtil定义了上下文</p>
<p>包含以下属性：</p>
<p>value:资源名称，必需项，不能为空</p>
<p>entryType :entry类型，可选项，默认为EntryType.OUT</p>
<p>blockHandler/blockHandlerClass：blockHandler对应处理BlockException的函数名称，是可选项，blockHabdler函数的访问范围需要是public，返回类型需要与原方法匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为BlockException。blockHandler函数默认需要和原方法在同一个类中，若希望使用其他类的函数，则可以指定blockHanderClass为对应的类的Class的对象，注意对应的函数必须为static函数，否则无法解析</p>
<p>fallback:fallback函数名称，可选项，用于在抛出异常的时候提供给fallback处理逻辑，fallback函数可以针对所有类型的异常(除了exceptionsToIgnore里面排除掉的异常类型)进行处理</p>
<p>fallback函数签名和位置要求：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个Throwable类型的参数用于接收对应的异常</li>
<li>fallback函数默认需要和原方法在同一个类中，若希望使用其他类的函数，则可以指定fallbackClass为对应的类的Class对象，注意对应的函数必须为static函数，否则无法解析</li>
</ul>
<p>defaultFallback：默认的fallback函数名称，可选项，通常用于通用的fallback逻辑，可以用于很多服务或方法，默认fallback函数可以针对所有类型的异常进行处理，若同时配置了fallback和defaultFallback，则只有fallback会生效，defaultFallback函数签名要求如下：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致</li>
<li>方法参数列表需要为空，或者可以额外多一个Throwable类型的参数用于接收对应的异常</li>
</ul>
<p>fallback只负责业务异常，blockHandler只负责sentinel空调配置的违规</p>
<h2 id="Sentinel持久化规则"><a href="#Sentinel持久化规则" class="headerlink" title="Sentinel持久化规则"></a>Sentinel持久化规则</h2><p>将限流配置规则持久化进Nacos保存，只要刷新8401某个res地址，sentinel控制台的流控规则就能看到，只要Nacos里面的规则不删除，针对8401上sentinel上的流控规则持续有效</p>
<p>使用sentinel-datasource-nacos持久化配置规则</p>
<p>配置ymal文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sentinel:</span><br><span class="line">      transport:</span><br><span class="line">        dashboard: localhost:8080 #配置Sentinel dashboard地址</span><br><span class="line">        port: 8719</span><br><span class="line">      datasource:</span><br><span class="line">        ds1:</span><br><span class="line">          nacos:</span><br><span class="line">            server-addr: localhost:8848</span><br><span class="line">            dataId: cloudalibaba-sentinel-service</span><br><span class="line">            groupId: DEFAULT_GROUP</span><br><span class="line">            data-type: json</span><br><span class="line">            rule-type: flow</span><br></pre></td></tr></table></figure>

<p>添加Nacos业务规则配置</p>
<ol>
<li>resource:资源名称</li>
<li>limitApp:来源应用</li>
<li>grade:阈值类型，0表示线程数，1表示QPS</li>
<li>count:单机阈值</li>
<li>strategy:流控模式，0表示直接，1表示关联，2表示链路</li>
<li>controlBehavior:流控效果，0表示快速失败，1表示Warm Up,2表示排队等待</li>
<li>clusterMode:是否集群</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;resource&quot;: &quot;&#x2F;rateLimit&#x2F;byUrl&quot;,</span><br><span class="line">        &quot;limitApp&quot;: &quot;default&quot;,</span><br><span class="line">        &quot;grade&quot;: 1,</span><br><span class="line">        &quot;count&quot;: 1,</span><br><span class="line">        &quot;strategy&quot;: 0,</span><br><span class="line">        &quot;controlBehavior&quot;: 0,</span><br><span class="line">        &quot;clusterMode&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="分布式事务的由来"><a href="#分布式事务的由来" class="headerlink" title="分布式事务的由来"></a>分布式事务的由来</h2><p>单体应用被拆分成微服务应用，原来的三个模块被拆分成三个独立的应用，分别使用三个独立的数据源，业务操作需要调用三个服务来完成，此时每个服务内部的数据一致性由本地事务来保证，但是全局的数据一致性问题没法保证</p>
<p>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ol>
<li>Transaction ID XID全局唯一的事务ID</li>
<li>Transaction Coordinator:事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚</li>
<li>Transaction Manager:控制全局事务的边界，并最终发起全局提交或全局回滚的决议</li>
<li>Resource Manager:控制分支事务，负责分支注册，状态汇报，并接收事务协调器的指令，驱动分支(本地)事务的提交和回滚</li>
</ol>
<ul>
<li>TC:事务协调者</li>
<li>TM:事务管理器</li>
<li>RM:资源管理器</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/010.png"  alt="springcloud"></p>
<ol>
<li>TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID</li>
<li>XID在微服务调用链路的上下文中传播</li>
<li>RM向TC注册分支事务，将其纳入XID对应全局事务的管辖</li>
<li>TM向TC发起针对XID的全局提交或回滚决议</li>
<li>TC调度XID下管辖的全部分支事务完成提交或回滚请求</li>
</ol>
<h3 id="SEATA的分布式交易解决方案"><a href="#SEATA的分布式交易解决方案" class="headerlink" title="SEATA的分布式交易解决方案"></a>SEATA的分布式交易解决方案</h3><p>我们只需要使用一个@GlobalTransactional注解在业务方法上</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/011.png"  alt="springcloud"></p>
<p>创建三个服务，一个订单服务，一个库存服务，一个账户服务</p>
<p>当用户下单时，会在订单服务中创建一个订单，然后通过远程调用库存服务来扣减下单商品的库存，再通过远程调用账户服务来扣减用户账户里面的余额，最后在订单服务中修改订单状态为已完成。该操作跨越三个数据库，有两次远程调用，很明显会有分布式事务问题</p>
<p>业务需求是下订单，减库存，扣余额，改订单状态</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>Seata是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务，提供了AT,TCC,SAGA和XA事务模式，为用户打造一站式的分布式解决方案，默认是AT模式</p>
<h5 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h5><p>基于支持本地ACID事务的关系型数据库</p>
<p>Java应用，通过jdbc访问数据库</p>
<h5 id="整体机制"><a href="#整体机制" class="headerlink" title="整体机制"></a>整体机制</h5><h6 id="一阶段"><a href="#一阶段" class="headerlink" title="一阶段"></a>一阶段</h6><p>业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源</p>
<ol>
<li>seata会拦截业务SQL，解析SQL语义，找到业务SQL要更新的业务数据，在业务数据被更新前，将其保存成before image</li>
<li>执行业务SQL更新业务数据，在业务数据更新之后</li>
<li>其保存成after image，最后生成行锁</li>
</ol>
<p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性</p>
<h6 id="二阶段"><a href="#二阶段" class="headerlink" title="二阶段"></a>二阶段</h6><ol>
<li><p>提交异步化，非常快速地完成</p>
<p>二阶段如果是顺利提交的话，因为业务SQL在一阶段已经提交至数据库，所以seata框架只需要将一阶段保存的快照数据和行锁删掉，完成数据清理即可</p>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/012.png"  alt="springcloud"></p>
</li>
<li><p>回滚通过一阶段的回滚日志进行反向补偿</p>
</li>
</ol>
<ul>
<li>二阶段如果是回滚的话，seata就需要回滚一阶段已经执行的业务SQL，还原数据</li>
<li>回滚方式便是用before image还原业务数据；但在还原前要首先检验脏写，对比数据库当前业务和after image，如果两份数据完全一致就说明没有脏写，可以还原业务数，如果不一致就说明有脏写，出现脏写就需要转人工处理</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/07/21/springcloud/013.png"  alt="springcloud"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">李上</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/07/21/springcloud/">http://yoursite.com/2020/07/21/springcloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">定不辱使命</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/28/hashmap/"><img class="prev_cover lazyload" data-src="/img/hashmap.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">HashMap源码分析</div></div></a></div><div class="next-post pull_right"><a href="/2020/07/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/"><img class="next_cover lazyload" data-src="/img/sharding-jdbc.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">数据库中间件</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 李上</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-sun-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js" ></script><script src="/js/utils.js" ></script><script src="/js/main.js" ></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>