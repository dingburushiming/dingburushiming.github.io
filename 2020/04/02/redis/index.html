<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis学习笔记 | 定不辱使命</title><meta name="description" content="Redis学习笔记"><meta name="keywords" content="事务,NOSQL,RDB,AOF,持久化,锁,数据类型"><meta name="author" content="李上"><meta name="copyright" content="李上"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis学习笔记"><meta name="twitter:description" content="Redis学习笔记"><meta name="twitter:image" content="http://yoursite.com/img/redis.png"><meta property="og:type" content="article"><meta property="og:title" content="Redis学习笔记"><meta property="og:url" content="http://yoursite.com/2020/04/02/redis/"><meta property="og:site_name" content="定不辱使命"><meta property="og:description" content="Redis学习笔记"><meta property="og:image" content="http://yoursite.com/img/redis.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css" ><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/04/02/redis/"><link rel="prev" title="Spring学习笔记" href="http://yoursite.com/2020/04/11/spring/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">25</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前置概念"><span class="toc-number">1.</span> <span class="toc-text">前置概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式："><span class="toc-number">1.1.</span> <span class="toc-text">分布式：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群"><span class="toc-number">1.2.</span> <span class="toc-text">集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储不同数据的方式"><span class="toc-number">1.3.</span> <span class="toc-text">存储不同数据的方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NOSQL-Not-Only-SQL"><span class="toc-number">2.</span> <span class="toc-text">NOSQL&#x3D;Not Only SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NOSQL的四大分类"><span class="toc-number">2.1.</span> <span class="toc-text">NOSQL的四大分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP"><span class="toc-number">2.2.</span> <span class="toc-text">CAP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE"><span class="toc-number">2.3.</span> <span class="toc-text">BASE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-Remote-Dictionary-Server远程字典服务器"><span class="toc-number">2.4.</span> <span class="toc-text">Redis: Remote Dictionary Server远程字典服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定义"><span class="toc-number">2.4.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特点"><span class="toc-number">2.4.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作用"><span class="toc-number">2.4.3.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内容"><span class="toc-number">2.4.4.</span> <span class="toc-text">内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis的下载安装"><span class="toc-number">2.4.5.</span> <span class="toc-text">redis的下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis常识"><span class="toc-number">2.4.6.</span> <span class="toc-text">redis常识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis命令"><span class="toc-number">2.4.7.</span> <span class="toc-text">redis命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis常用五大数据类型："><span class="toc-number">2.4.8.</span> <span class="toc-text">redis常用五大数据类型：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis字符串-String"><span class="toc-number">2.4.8.1.</span> <span class="toc-text">redis字符串(String)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis列表-List"><span class="toc-number">2.4.8.2.</span> <span class="toc-text">redis列表(List)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis集合-Set"><span class="toc-number">2.4.8.3.</span> <span class="toc-text">redis集合(Set)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis哈希-Hash"><span class="toc-number">2.4.8.4.</span> <span class="toc-text">redis哈希(Hash)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis有序集合Zset-sorted-set"><span class="toc-number">2.4.8.5.</span> <span class="toc-text">redis有序集合Zset(sorted set)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis配置文件"><span class="toc-number">2.4.9.</span> <span class="toc-text">redis配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis持久化"><span class="toc-number">2.4.10.</span> <span class="toc-text">Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB-redis-database，默认是关闭的"><span class="toc-number">2.4.10.1.</span> <span class="toc-text">RDB:redis database，默认是关闭的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#持久化原理"><span class="toc-number">2.4.10.1.1.</span> <span class="toc-text">持久化原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#持久化指令"><span class="toc-number">2.4.10.1.2.</span> <span class="toc-text">持久化指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RDB持久化策略Redis-conf配置"><span class="toc-number">2.4.10.1.3.</span> <span class="toc-text">RDB持久化策略Redis.conf配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RDB总结"><span class="toc-number">2.4.10.1.4.</span> <span class="toc-text">RDB总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF：append-only-file"><span class="toc-number">2.4.10.2.</span> <span class="toc-text">AOF：append only file</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AOF持久化策略Redis-conf配置"><span class="toc-number">2.4.10.2.1.</span> <span class="toc-text">AOF持久化策略Redis.conf配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AOF修复数据库"><span class="toc-number">2.4.10.2.2.</span> <span class="toc-text">AOF修复数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#aof正常修复"><span class="toc-number">2.4.10.2.2.1.</span> <span class="toc-text">aof正常修复</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#aof异常恢复"><span class="toc-number">2.4.10.2.2.2.</span> <span class="toc-text">aof异常恢复</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#aof的Rewrite"><span class="toc-number">2.4.10.2.2.3.</span> <span class="toc-text">aof的Rewrite</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#aof比对rdb的优缺点"><span class="toc-number">2.4.10.2.3.</span> <span class="toc-text">aof比对rdb的优缺点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#aof总结"><span class="toc-number">2.4.10.2.4.</span> <span class="toc-text">aof总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis事务"><span class="toc-number">2.4.11.</span> <span class="toc-text">redis事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常见命令"><span class="toc-number">2.4.11.1.</span> <span class="toc-text">常见命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事务策略"><span class="toc-number">2.4.11.2.</span> <span class="toc-text">事务策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#悲观锁，乐观锁的区别"><span class="toc-number">2.4.11.3.</span> <span class="toc-text">悲观锁，乐观锁的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#悲观锁-类似于表锁，行锁，读锁，写锁等"><span class="toc-number">2.4.11.3.1.</span> <span class="toc-text">悲观锁(类似于表锁，行锁，读锁，写锁等)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#乐观锁Cas-check-and-set"><span class="toc-number">2.4.11.3.2.</span> <span class="toc-text">乐观锁Cas(check and set)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#注意redis乐观锁和juc的cas-compareandswap-不同"><span class="toc-number">2.4.11.3.2.1.</span> <span class="toc-text">注意redis乐观锁和juc的cas(compareandswap)不同</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysql事务和redis事务的对比"><span class="toc-number">2.4.11.4.</span> <span class="toc-text">mysql事务和redis事务的对比</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#redis事务-1"><span class="toc-number">2.4.11.4.1.</span> <span class="toc-text">redis事务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mysql事务"><span class="toc-number">2.4.11.4.2.</span> <span class="toc-text">mysql事务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis消息订阅发布简介"><span class="toc-number">2.4.12.</span> <span class="toc-text">redis消息订阅发布简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis的主从复制（master-slave）"><span class="toc-number">2.4.13.</span> <span class="toc-text">redis的主从复制（master&#x2F;slave）</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/redis.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">定不辱使命</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Redis学习笔记</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-02 22:17:25"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-04-28 16:58:56"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-28</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="前置概念"><a href="#前置概念" class="headerlink" title="前置概念"></a>前置概念</h1><h2 id="分布式："><a href="#分布式：" class="headerlink" title="分布式："></a>分布式：</h2><p>不同的多台服务器上部署不同的服务模块，他们之间通过RPC/RMI通信和调用，对外提供服务和组内协作</p>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>不同的多台服务器上部署相同的服务器模块，通过分布式调度软件进行统一的调度，对外提供服务和访问</p>
<h2 id="存储不同数据的方式"><a href="#存储不同数据的方式" class="headerlink" title="存储不同数据的方式"></a>存储不同数据的方式</h2><p>存储工具：适合存储哪方面的数据</p>
<p>Mysql:存储商品基本信息</p>
<p>MongoDB:商品描述，详情，评价信息等多文字类</p>
<p>商品的图片</p>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image001.png"  alt="redis"></p>
<p>搜索引擎ISearch,淘宝内用：商品的关键字</p>
<p>缓存数据库Tair,Redis,Memcache：商品的波段性的热点高频信息</p>
<h1 id="NOSQL-Not-Only-SQL"><a href="#NOSQL-Not-Only-SQL" class="headerlink" title="NOSQL=Not Only SQL"></a>NOSQL=Not Only SQL</h1><p>不仅仅是SQL,泛指非关系型数据库</p>
<p>优点：</p>
<p>数据类型简单易改动，这些类型的数据存储不需要固定模式，无需多余的操作就可以横向扩展</p>
<h2 id="NOSQL的四大分类"><a href="#NOSQL的四大分类" class="headerlink" title="NOSQL的四大分类"></a>NOSQL的四大分类</h2><p>1.KV键值，redis就是属于这一类</p>
<p>2.Bson文档型数据库</p>
<p>MongoDB是一个基于分布式文件存储的数据库，是一个典型的Bson文档型数据库</p>
<p>3.列存储数据库</p>
<p>HBase</p>
<p>4.图形存储数据库(存复杂关系的，不是存图片的)</p>
<p>朋友圈社交关系，广告推荐系统，专注于构建关系图谱</p>
<p>Neo4J,InfoGrid</p>
<h2 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h2><p>在分布式数据库中CAP原理CAP+BASE（对标关系型数据库的ACID）</p>
<p>C:Consistency 强一致性，即数据库的数据的准确性，延迟准确</p>
<p>A:Availability 可用性</p>
<p>P:Partition tolerance 分区容错性，必须要满足</p>
<p>cap的三个特性只能同时满足两个</p>
<ul>
<li><p>CA:单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大</p>
<p>eg:传统的Oracle数据库</p>
</li>
<li><p>CP:满足一致性，分区容忍性的系统，通常性能不是特别高</p>
</li>
</ul>
<p>​        eg:大多数网站架构的选择</p>
<ul>
<li><p>AP:满足可用性，分区容忍性的系统，通常可能对一致性要求低一些</p>
<p>eg:Redis,MongoDB</p>
</li>
</ul>
<h2 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h2><p>定义：就是为了解决关系数据库强一致性引起的问题而引起的可用性降低而提出的解决方案</p>
<p>Basically Available:基本可用</p>
<p>Soft state:软状态</p>
<p>Eventually consistent：最终一致</p>
<p>通过让系统放松对某一时刻数据一致性的要求来换取系统整体伸缩性和性能上的改观</p>
<h2 id="Redis-Remote-Dictionary-Server远程字典服务器"><a href="#Redis-Remote-Dictionary-Server远程字典服务器" class="headerlink" title="Redis: Remote Dictionary Server远程字典服务器"></a>Redis: Remote Dictionary Server远程字典服务器</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ol>
<li><p>完全开源的，用C语言编写的，遵循BSD协议</p>
</li>
<li><p>高性能的key/value分布式内存数据库，基于内存运行</p>
</li>
<li><p>支持持久化NOSQL数据库，是数据结构服务</p>
</li>
</ol>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol>
<li><p>redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用</p>
</li>
<li><p>redis不仅仅支持简单的key-value类型的数据，同时还提供list,set，zset,hash 等数据结构的存储</p>
</li>
<li><p>redis支持数据的备份，即master-slave模式的数据备份</p>
</li>
</ol>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ol>
<li>内存存储和持久化：redis支持异步将内存中的数据写到磁盘上，同时不影响服务</li>
<li>可以模拟类似于HttpSession这种需要设定过期时间的功能</li>
<li>发布，订阅消息系统,定时器，计数器</li>
</ol>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><ul>
<li>数据类型，基本操作，配置</li>
<li>持久化和赋值,RDB/AOF</li>
<li>事务的控制</li>
<li>复制</li>
</ul>
<h3 id="redis的下载安装"><a href="#redis的下载安装" class="headerlink" title="redis的下载安装"></a>redis的下载安装</h3><p>1.下载获得redis-tar.gz压缩包后将它放入linux目录/opt</p>
<p>2./opt目录下，解压命令：tar -zxvf redis.tar.gz</p>
<p>3.解压后进行该文件夹redis,在redis目录下执行make命令</p>
<p>4.make执行完毕后接着执行make install，执行失败可以执行make distclean</p>
<p>5.查看默认安装目录：usr/local/bin</p>
<p>6.启动</p>
<p>​    启动服务器，客户端</p>
<p>​    redis-server /myredis/redis.conf</p>
<p>​    redis-cli -p 6379</p>
<p>​    关闭数据库</p>
<p>​    shutdown,exit</p>
<h3 id="redis常识"><a href="#redis常识" class="headerlink" title="redis常识"></a>redis常识</h3><ul>
<li>redis是单进程的</li>
<li>redis一共有个数据库，通过select来切换数据库</li>
<li>flushDB清空当前数据库</li>
<li>flushALl清空所有数据库</li>
<li>16个库都是同样的密码</li>
<li>redis默认的端口是6379</li>
<li>redis命令参考网址：Redisdoc.com</li>
</ul>
<h3 id="redis命令"><a href="#redis命令" class="headerlink" title="redis命令"></a>redis命令</h3><ul>
<li><p>Set key value</p>
<p>设置键值</p>
</li>
<li><p>Get key</p>
<p>获得键值</p>
</li>
<li><p>Select I</p>
<p>切换数据库</p>
</li>
<li><p>Keys *</p>
<p>查看当前数据库所有的键</p>
</li>
<li><p>Move k I</p>
<p>移动键值到另外的数据库</p>
</li>
<li><p>Ttl k</p>
<p>返回该键值剩余的生存时间</p>
</li>
<li><p>Expire k time</p>
<p>设置键值过期时间</p>
</li>
<li><p>Exist k</p>
<p>判断当前数据库是否存在该键</p>
</li>
<li><p>Type k</p>
<p>查看键的数据类型</p>
</li>
<li><p>Del k</p>
<p>删除键值</p>
</li>
</ul>
<h3 id="redis常用五大数据类型："><a href="#redis常用五大数据类型：" class="headerlink" title="redis常用五大数据类型："></a>redis常用五大数据类型：</h3><h4 id="redis字符串-String"><a href="#redis字符串-String" class="headerlink" title="redis字符串(String)"></a>redis字符串(String)</h4><ol>
<li><p>String类型是二进制安全的，String可以包含任何数据，比如jpg图片或者序列化的对象</p>
</li>
<li><p>一个redis中字符串value最多可以是512M</p>
</li>
<li><p>字符串的相关指令</p>
<ul>
<li>Append/Strlen</li>
</ul>
<p>​        追加字符/判断长度</p>
<ul>
<li><p>Incr/decr/incrby/decrby</p>
<p> 自增1/自减1/给定值自增/给定值自减</p>
</li>
<li><p>Getrange/setrange</p>
<p>获得数据库指定索引范围的键值/覆盖指定key当前存储的数据，替换为新数据</p>
</li>
<li><p>Setex:setex k time value</p>
<p>设置新值并设定过期时间</p>
</li>
<li><p>Setnx:setnx k value</p>
<p>插入键不存在才执行插入数据操作</p>
</li>
<li><p>Mset/mget/msetnx</p>
<p>同时设置/获取/不存在才插入键值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image002.png"  alt="redis"></p>
</li>
</ol>
<h4 id="redis列表-List"><a href="#redis列表-List" class="headerlink" title="redis列表(List)"></a>redis列表(List)</h4><p>底层是一个链表，按照插入顺序排序，可以添加数据到集合的头部，也可以添加到尾部</p>
<p>字符串链表，left,right都可以插入，链表头尾操作效率高，中间插入效率低</p>
<ul>
<li><p>Lpush/rpush/lrange</p>
<p>反向存入list数据/正向存入list数据/获取范围内的键值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image003.png"  alt="redis"></p>
<ul>
<li><p>lpop/rpop</p>
<p>弹出后就没了，头部出栈/尾部出栈</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image004.png"  alt="redis"></p>
<ul>
<li><p>Lindex/Llen/Lrem key</p>
<p>按照索引下标获得元素(从上到下)/查看list长度/删除N个value</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image005.png"  alt="redis"></p>
<ul>
<li><p>Ltrim key</p>
<p>开始index,结束index,截取指定范围的值后再赋值给key</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image006.png"  alt="redis"></p>
<ul>
<li><p>Rpoplpush 源列表 目的列表</p>
<p>将源列表的尾部数据放到目的列表的头部</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image007.png"  alt="redis"></p>
<ul>
<li><p>Lset key index value</p>
<p>替换指定索引位置的值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image008.png"  alt="redis"></p>
<ul>
<li><p>Linsert list before/after v1 v2</p>
<p>在v1前面/后面插入数据v2</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image009.png"  alt="redis"></p>
<h4 id="redis集合-Set"><a href="#redis集合-Set" class="headerlink" title="redis集合(Set)"></a>redis集合(Set)</h4><ol>
<li><p>Set是string类型的无序集合， 是通过hashmap实现的</p>
</li>
<li><p>类似于java中Map&lt;String,Object&gt;</p>
</li>
<li><p>不允许重复元素</p>
</li>
</ol>
<ul>
<li><p>Sadd/smembers/sismember</p>
<p>写/查/读</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image010.png"  alt="redis"></p>
<ul>
<li><p>Scard</p>
<p>获取集合中元素的个数</p>
</li>
<li><p>Srem key value</p>
<p>删除集合中的元素</p>
</li>
<li><p>Srandmember key 某个整数</p>
<p>随机出几个数字</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image011.png"  alt="redis"></p>
<ul>
<li><p>Spop key</p>
<p>随机出栈</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image012.png"  alt="redis"></p>
<ul>
<li><p>Smove key1 key2 在kye1里某个值</p>
<p>将key1里的某个值赋值给key2</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image013.png"  alt="redis"></p>
<ul>
<li><p>Sdiff/sinter/sunion</p>
<p>差/交/并 </p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image014.png"  alt="redis"></p>
<h4 id="redis哈希-Hash"><a href="#redis哈希-Hash" class="headerlink" title="redis哈希(Hash)"></a>redis哈希(Hash)</h4><p>无序的数据结构</p>
<ul>
<li>Hset/hget/hmset/hmget/hgetall/hdel</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image015.png"  alt="redis"></p>
<ul>
<li><p>Hlen key</p>
<p>hash键的长度</p>
</li>
<li><p>Hexists key 在key里面的某个值的key</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image016.png"  alt="redis"></p>
<ul>
<li><p>Hkeys/hvals</p>
<p>获得键/获得值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image017.png"  alt="redis"></p>
<ul>
<li><p>Hincrby/hincrbyfloat</p>
<p>整数递增/浮点型递增</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image018.png"  alt="redis"></p>
<ul>
<li><p>Hsetnx</p>
<p>不存在才能插入数据</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image019.png"  alt="redis"></p>
<h4 id="redis有序集合Zset-sorted-set"><a href="#redis有序集合Zset-sorted-set" class="headerlink" title="redis有序集合Zset(sorted set)"></a>redis有序集合Zset(sorted set)</h4><ol>
<li><p>和set一样也是string类型元素的结合，且不允许重复的成员，不同的是每个元素都会关联一个double类型的分数</p>
</li>
<li><p>redis正是通过分数为集合中的成员进行从小到大的排序，zset的成员是唯一的，但是分数是可以重复的</p>
</li>
<li><p>在set基础上，加一个score值，二者之间的区别：</p>
<p>Set:k1 v1 v2 v3 </p>
<p>Zset:k1 score1 v1 k2 score2 v2</p>
</li>
</ol>
<ul>
<li><p>Zadd/zrange [withscores]</p>
<p>新增zest数据/查找范围内的键值[有无]</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image020.png"  alt="redis"></p>
<ul>
<li><p>Zrangebyscore key 开始score 结束score </p>
<p>(：不包含</p>
<p>Limit:分页查询</p>
<p>查找指定分数范围内的键值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image021.png"  alt="redis"></p>
<ul>
<li><p>Zrem key 某score下对应的value值</p>
<p>删除元素</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image022.png"  alt="redis"></p>
<ul>
<li><p>Zcard/zcount key score区间/zrank key values/zscore key</p>
<p>统计个数/统计socre区间个数/获取获得下标值/获得分数</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image023.png"  alt="redis"></p>
<ul>
<li><p>Zrevrank key values值</p>
<p>逆序获得下标值</p>
<p>V4的下标本应该是3</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image024.png"  alt="redis"></p>
<ul>
<li><p>Zrevrange</p>
<p>逆序获得键值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image025.png"  alt="redis"></p>
<ul>
<li><p>Zrevrangebyscore key 开始score 结束score</p>
<p>逆序获得socre范围内的键值</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image026.png"  alt="redis"></p>
<h3 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h3><ul>
<li><p>units单位</p>
<p>​    只支持bytes,不支持bit</p>
<p>​    对大小写不敏感</p>
<p>​    k/m/g != kb/mb/gb</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image027.png"  alt="redis"></p>
<p>​    </p>
<ul>
<li><p>Includes</p>
<p>可以引用本地或者其他地方的配置文件</p>
</li>
</ul>
<ul>
<li><p>general通用</p>
<p>Daemonize no/yes </p>
<p>默认为no,默认的redis不作为守护进程运行</p>
</li>
</ul>
<ul>
<li><p>Pidfile /var/run/redis.pid</p>
<p>指定pid文件的默认路径</p>
</li>
</ul>
<ul>
<li><p>Tcp-backlog</p>
<p>默认配置511</p>
<p>backlog是一个消息队列，backlog队列总和=未完成三次握手队列+完成三次握手队列</p>
<p>在高并发环境下需要一个高backlog值来避免慢客户端连接问题</p>
</li>
</ul>
<ul>
<li><p>timeout 0</p>
<p>客户端没有消息后，多长时间才断开连接，默认为0</p>
</li>
</ul>
<ul>
<li><p>Tcp-keepalive 0</p>
<p>设置为0则不会进行keepalive检测，建议设置为60</p>
<p>每隔间隔时间，检查通讯状态是否良好</p>
</li>
</ul>
<ul>
<li><p>Loglevel notice</p>
<p>日志级别</p>
<p>Debug</p>
<p>Verbose</p>
<p>Notice</p>
<p>warning</p>
</li>
</ul>
<ul>
<li><p>Logfile “”</p>
<p>日志名称</p>
</li>
</ul>
<ul>
<li><p>Syslog-enabled no</p>
<p>是否开启系统日志</p>
</li>
<li><p>Syslog-ident redis</p>
<p>指定系统日志的标识</p>
</li>
<li><p>Syslog-facility local 0</p>
<p>指定系统日志的功能必须是user或者介于local 0 -local 7之间</p>
</li>
<li><p>Databases 16</p>
<p>指定数据库数量</p>
</li>
</ul>
<ul>
<li><p>Bind 127.0.0.1</p>
<p>绑定数据库主机</p>
</li>
</ul>
<ul>
<li><p>limits限制</p>
<p>Maxclients 10000</p>
<p>默认最大一万个连接</p>
</li>
</ul>
<ul>
<li><p>Maxmemory <bytes></bytes></p>
<p>最大内存值</p>
</li>
</ul>
<ul>
<li><p>Maxmemory-policy noeviction</p>
<p>缓存过期清洁策略，默认noeviction永不过期</p>
<p>LRU(last recently use):最近最少使用</p>
<ol>
<li>Volatile-lru:针对对设置了过期时间的键，使用lru算法移除key</li>
<li>Allkeys-lru:所有的key,使用lru算法移除key</li>
<li>volatile-random:正对设置了过期时间的key，在过期集合中随机移除key</li>
<li>Allkeys-random:所有的key，随机移除</li>
<li>Volatile-ttl:对要过期的key,移除ttl最小的可以</li>
<li>Noeviction:针对写操作，只返回错误信息，不进行移除</li>
</ol>
</li>
</ul>
<ul>
<li><p>Maxmemory-samples 5</p>
<p>默认值为5，选取样本做缓存测试，用来做缓存清洁</p>
</li>
</ul>
<ul>
<li><p>Config get dir </p>
<p>常见的config配置</p>
<p>查看本地数据库的存放目录</p>
</li>
</ul>
<ul>
<li><p>security安全</p>
<p>给redis数据库设置密码的方式</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image028.png"  alt="redis"></p>
<h3 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h3><h4 id="RDB-redis-database，默认是关闭的"><a href="#RDB-redis-database，默认是关闭的" class="headerlink" title="RDB:redis database，默认是关闭的"></a>RDB:redis database，默认是关闭的</h4><p>1.在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是snapshot快照，它恢复时是将快照文件直接读到内存中</p>
<p>2.redis会单独创建一个子进程来进行持久化</p>
<p>3.先将数据写入到一个临时文件，待持久化过程完全结束，再用这个临时文件替换上次持久化好的文件</p>
<p>4.整个过程中，主进程是不进行任何io操作的，这确保了极高的性能</p>
<p>5.如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那么RDB方式要比AOF方式更为高效</p>
<p>6.RDB的缺点是最后一次持久化后的数据可能丢失，即临时表转正过程中发生错误</p>
<h5 id="持久化原理"><a href="#持久化原理" class="headerlink" title="持久化原理"></a>持久化原理</h5><ol>
<li>克隆一个与自己完全一样的子进程将数据写入到dump.rdb文件中</li>
<li>Fork:复制一个与当前进程一样的进程，新进程的所有数据(变量，环境变量，程序计数器等)，数值都和原进程一样，并作为原进程的子进程</li>
<li>可以通过备份dump.rdb文件来达到恢复数据库的目的</li>
</ol>
<h5 id="持久化指令"><a href="#持久化指令" class="headerlink" title="持久化指令"></a>持久化指令</h5><ul>
<li><p>Dump.rdb文件：数据保存到磁盘上的rdb文件上</p>
</li>
<li><p>Sava:直接强制备份，会阻塞redis的其他操作</p>
</li>
<li><p>Bgsave:在后台进行异步快照操作，备份同时还可以响应客户端请求</p>
</li>
<li><p>Lastsave:获取最后一次成功执行快照的时间</p>
</li>
<li><p>redis-cli config set save “”：禁用rdb持久化策略，只要不设置任何save指令，或者给save传入一个空字符串参数即可,</p>
</li>
</ul>
<h5 id="RDB持久化策略Redis-conf配置"><a href="#RDB持久化策略Redis-conf配置" class="headerlink" title="RDB持久化策略Redis.conf配置"></a>RDB持久化策略Redis.conf配置</h5><ul>
<li><p>save <seconds> <changes> 在指定的时间内如果更改数据的次数达到指定值，那么将数据刷到dump.rdb文件中</changes></seconds></p>
</li>
<li><p>Dbfilename dump.rdb 默认的数据存储文件dump.rdb</p>
</li>
</ul>
<ul>
<li><p>RDB是整个内存压缩过的snapshot快照，可以配合复合的快照触发条件：</p>
<p>一分钟内改1万次</p>
<p>五分钟内改10次</p>
<p>十五分钟内改1次</p>
</li>
</ul>
<ul>
<li><p>Stop-writes-on-bgsave-error yes</p>
<p>默认值为yes，发生错误就停止操作</p>
</li>
</ul>
<ul>
<li><p>Rdbcompression yes</p>
<p>默认为yes,对于存储到磁盘中的快照，可以设置是否压缩存储，如果是的话，redis会采用lzf算法进行压缩</p>
<p>lzf算法会消耗额外的cpu性能</p>
</li>
</ul>
<ul>
<li><p>Rdbchecksum yes</p>
<p>在存储快照后，可以让redis使用CRC64算法来进行数据校验</p>
<p>会增加大约10%的性能消耗</p>
</li>
</ul>
<h5 id="RDB总结"><a href="#RDB总结" class="headerlink" title="RDB总结"></a>RDB总结</h5><p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image029.png"  alt="redis"></p>
<h4 id="AOF：append-only-file"><a href="#AOF：append-only-file" class="headerlink" title="AOF：append only file"></a>AOF：append only file</h4><ol>
<li><p>以日志的形式来记录每个写操作，只许追加文件但不可以改写文件</p>
</li>
<li><p>redis启动之初会读取该文件重新构建数据</p>
</li>
<li><p>启动的时候调用redis-aof.conf配置文件(自定义的，其实就是redis.conf)就可以使用aof，会在/usr/local/bin目录下生成一个appendonly.aof文件</p>
</li>
<li><p>aof文件会记录所有的写操作，包括flushall</p>
</li>
<li><p>Appendonly.aof和dump.rdb是可以共存的，优先执行前者</p>
</li>
</ol>
<h5 id="AOF持久化策略Redis-conf配置"><a href="#AOF持久化策略Redis-conf配置" class="headerlink" title="AOF持久化策略Redis.conf配置"></a>AOF持久化策略Redis.conf配置</h5><ul>
<li><p>Appendonly no</p>
<p>默认为no不开启</p>
</li>
<li><p>Appendfilename “appendonly.aof”</p>
<p>记录文件</p>
</li>
</ul>
<ul>
<li><p>Appendfsync always/everysec/no</p>
<p>将数据刷入到aof文件中的频率</p>
<p>Always:同步持久化，每次发生数据变更会被立即记录到磁盘，性能较差但数据完整性比较好</p>
<p>Evertsec:默认推荐，异步操作，每秒记录，如果一秒内宕机，有数据丢失</p>
<p>No:从不同步</p>
</li>
</ul>
<ul>
<li><p>No-appendfsync-on-rewrite</p>
<p>重写时是否可以运用appendfsync</p>
<p>用默认的no 即可，保证数据安全性</p>
</li>
</ul>
<ul>
<li><p>Auto-aof-rewrite-min-size</p>
</li>
<li><p>Auto-aof-rewrite-percentage</p>
<p>设置重写的基准值</p>
</li>
</ul>
<ul>
<li><p>redis-check-aof –fix appendonly.aof </p>
<p>通过Appendonly.aof来修复数据库，命令会将aof文件中不符合要求的指令全部干掉</p>
</li>
</ul>
<h5 id="AOF修复数据库"><a href="#AOF修复数据库" class="headerlink" title="AOF修复数据库"></a>AOF修复数据库</h5><h6 id="aof正常修复"><a href="#aof正常修复" class="headerlink" title="aof正常修复"></a>aof正常修复</h6><p>1.设置appendonly 参数为yes</p>
<p>2.将有指令数据的aof文件复制一份保存到对应目录， config get dir</p>
<p>3.重启redis然后重新加载</p>
<h6 id="aof异常恢复"><a href="#aof异常恢复" class="headerlink" title="aof异常恢复"></a>aof异常恢复</h6><p>1.备份被写坏的aof文件</p>
<p>2.redis-check-aof –fix appendonly.aof 进行修复</p>
<p>3.重启redis然后重新加载</p>
<h6 id="aof的Rewrite"><a href="#aof的Rewrite" class="headerlink" title="aof的Rewrite"></a>aof的Rewrite</h6><p>1.文件压缩重写指令</p>
<p>2.aof采用文件追加，文件会越来越大，为避免出现这种情况，新增了重写机制</p>
<p>3.当aof文件的大小超过所设定的阈值时，redis就会启动aof文件的内容压缩</p>
<p>4.只保留可以恢复数据的最小指令集，可以使用该命令bgrewriteaof</p>
<p>触发机制</p>
<p>redis会记录上次重写时的aof大小，默认配置时当aof文件大小是上次rewrite后大小的一倍且文件大于64M时触发</p>
<h5 id="aof比对rdb的优缺点"><a href="#aof比对rdb的优缺点" class="headerlink" title="aof比对rdb的优缺点"></a>aof比对rdb的优缺点</h5><ul>
<li><p>优点：同步机制完善</p>
</li>
<li><p>缺点：相同数据集的数据，aof文件要远大于rdb文件，运行恢复速度慢于rdb</p>
</li>
</ul>
<h5 id="aof总结"><a href="#aof总结" class="headerlink" title="aof总结"></a>aof总结</h5><p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image030.png"  alt="redis"></p>
<ul>
<li><p>rdb备份能力不如aof,会丢失数据，aof能够很好的保存数据，最多就是不超过两秒的数据</p>
</li>
<li><p>aof会频繁的io,重写，所以有更好的方法就是主从复制</p>
</li>
</ul>
<h3 id="redis事务"><a href="#redis事务" class="headerlink" title="redis事务"></a>redis事务</h3><ul>
<li><p>可以一次执行多个命令，本质上是一组命令的集合</p>
</li>
<li><p>一个事务所有的命令都会序列化，按顺序地串行化执行而不会被其他命令插入，不许加塞</p>
</li>
</ul>
<h4 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h4><p>Multi 标记一个事务块的开始</p>
<p>Discard 取消事务</p>
<p>Exec 执行所有事务块内的命令</p>
<p>Unwatch 取消watch命令对所有key的监视</p>
<p>Watch key[key…] 监视一一个或多个key,如果在事务执行之前key被其他命令所改动，那么事务将被打断</p>
<h4 id="事务策略"><a href="#事务策略" class="headerlink" title="事务策略"></a>事务策略</h4><ol>
<li><p>全体连坐</p>
<ul>
<li><p>拼写等简单错误，在输入指令后就可以被检测出来报错</p>
</li>
<li><p>如果事务队列中出现了错误，那么整个事务队列都无法执行成功</p>
</li>
</ul>
</li>
</ol>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image031.png"  alt="redis"></p>
<ol start="2">
<li>冤头债主</li>
</ol>
<ul>
<li><p>K1的值是aa,所以加1是无法执行的，事务执行时会报错</p>
</li>
<li><p>冤头债主说明redis的事务并不是强一致性</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image032.png"  alt="redis"></p>
<ol start="3">
<li><p>watch监控(乐观锁做法)</p>
<p>在事务操作事务时，另外一个操作更改了该事务想要操作的数据，那么该事务执行结果会为nil空</p>
</li>
</ol>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image033.png"  alt="redis"></p>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image034.png"  alt="redis"></p>
<p>解决办法：</p>
<ul>
<li><p>unwatch解除目标数据的监控，重新抓取数据进行操作</p>
</li>
<li><p>一旦执行了unwatch,exec，之前加的监控锁都会被取消</p>
</li>
</ul>
<h4 id="悲观锁，乐观锁的区别"><a href="#悲观锁，乐观锁的区别" class="headerlink" title="悲观锁，乐观锁的区别"></a>悲观锁，乐观锁的区别</h4><h5 id="悲观锁-类似于表锁，行锁，读锁，写锁等"><a href="#悲观锁-类似于表锁，行锁，读锁，写锁等" class="headerlink" title="悲观锁(类似于表锁，行锁，读锁，写锁等)"></a>悲观锁(类似于表锁，行锁，读锁，写锁等)</h5><p>并发性差，一致性好</p>
<h5 id="乐观锁Cas-check-and-set"><a href="#乐观锁Cas-check-and-set" class="headerlink" title="乐观锁Cas(check and set)"></a>乐观锁Cas(check and set)</h5><ol>
<li><p>一致性差，并发性好</p>
</li>
<li><p>工作中一般都是用乐观锁，乐观锁就是不上锁，通过版本号控制数据的一致性</p>
</li>
<li><p>如何解决乐观锁一致性差的问题：提交版本必须大于当前记录版本才能执行更新<br> 在表中加上一个version版本号字段</p>
</li>
<li><p>并发执行过程中如果发现自己读取的版本号与数据库当前的版本号不同，就报错</p>
</li>
</ol>
<h6 id="注意redis乐观锁和juc的cas-compareandswap-不同"><a href="#注意redis乐观锁和juc的cas-compareandswap-不同" class="headerlink" title="注意redis乐观锁和juc的cas(compareandswap)不同"></a>注意redis乐观锁和juc的cas(compareandswap)不同</h6><p>Cas(compare and swap):典型的乐观锁算法(C语言实现的操作系统底层算法，效率高)</p>
<p>   线程A和线程B从内存中读取数据56，同时抢夺cpu资源，A抢夺成功将内存中数据修改为57（失败的B线程不会被挂起，会接着尝试抢夺资源），当线程B抢夺到资源准备时检测到内存中的数据和自己副本中的数据56不等，B的这次操作就失败了，B会重新到内存中读取数据56，重新参与cpu资源的抢夺。（包装线程共享变量）</p>
<h4 id="mysql事务和redis事务的对比"><a href="#mysql事务和redis事务的对比" class="headerlink" title="mysql事务和redis事务的对比"></a>mysql事务和redis事务的对比</h4><h5 id="redis事务-1"><a href="#redis事务-1" class="headerlink" title="redis事务"></a>redis事务</h5><ul>
<li><p>redis不保证原子性：redis同一个事务中如果一条命令执行失败，其后的命令仍然会被执行，没有回滚.redis部分支持事务性</p>
</li>
<li><p>redis单独的隔离级别：事务中所有的命令都会序列化，按顺序执行。事务执行过程中，不会被其他客户端发来的请求插队或者打断。等同于mysql的Serializable隔离级别。事务内的操作过程外部是不可见的</p>
</li>
</ul>
<h5 id="mysql事务"><a href="#mysql事务" class="headerlink" title="mysql事务"></a>mysql事务</h5><p>mysql事务并发问题：</p>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image035.png"  alt="redis"></p>
<ul>
<li><p>Read uncommitted(未提交读，其他事务可见)：</p>
<p>允许事务读取未被其他事务提交的数据，脏读，不可重复读和幻读的问题都会出现（性能不高，安全性极差，基本不使用）</p>
</li>
<li><p>Read committed(提交读，不可重复读):</p>
<p>只允许事务读取已经被其他事务提交的变更，满足隔离性。连续两次读取的数据可能不一样，会有不可重复读并发问题</p>
</li>
<li><p>Repeatable read(可重复读，mysql 的默认隔离级别):</p>
<p>确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其他事务对这个字段进行更新，但是可以插入新的行</p>
</li>
<li><p>Serializable(可串行化):</p>
<p>确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其他事务对该表执行插入，更新和删除操作，所有的并发问题都可以避免，但性能十分低下，只有在非常需要确保数据的一致性而且可以接收没有并发的情况下才会使用</p>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="/2020/04/02/redis/clip_image036.png"  alt="redis"></p>
<h3 id="redis消息订阅发布简介"><a href="#redis消息订阅发布简介" class="headerlink" title="redis消息订阅发布简介"></a>redis消息订阅发布简介</h3><ul>
<li><p>redis有这个功能,但是消息中间件不会用redis</p>
</li>
<li><p>一次性订阅多个，subscribe c1 c2 c3</p>
</li>
<li><p>消息发布，publish c2 hello-redis</p>
</li>
<li><p>订阅多个，通配符<em>，psubscribe new</em></p>
</li>
</ul>
<h3 id="redis的主从复制（master-slave）"><a href="#redis的主从复制（master-slave）" class="headerlink" title="redis的主从复制（master/slave）"></a>redis的主从复制（master/slave）</h3><p>主要功能：</p>
<ul>
<li><p>读写分离，容灾恢复</p>
</li>
<li><p>主机数据更新后根据配置和策略，自动同步到备机的master/slaver机制</p>
</li>
<li><p>Master以写为主，slave以读为主</p>
</li>
<li><p>读写分离，主库负责写，从库负责读，从库不能写入数据</p>
</li>
</ul>
<p>如何使用</p>
<ol>
<li>配从库不配主库，从库配置：slaveof 主库ip 主库端口</li>
</ol>
<ul>
<li><p>1.从库每次和主库，master断开后，都需要重新连接，除非配置进redis.conf文件</p>
</li>
<li><p>2.Info replication，查看当前数据库在主从复制中的状态</p>
</li>
</ul>
<ol start="2">
<li>修改配置文件细节操作</li>
</ol>
<ul>
<li><p>1.拷贝多个redis.conf文件</p>
</li>
<li><p>2.开启daemonize yes</p>
</li>
<li><p>3.pid文件名字</p>
</li>
<li><p>4.指定端口</p>
</li>
<li><p>5.log文件名字</p>
</li>
<li><p>6.dump.rdb名字</p>
</li>
</ul>
<p>复制原理</p>
<ul>
<li>slave启动成功，连接到master,master会发送一个sync命令</li>
<li>Mastere接到命令启动后台的存盘系统，同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕之后，master将传送整个数据文件到slave</li>
<li>全量复制：slave服务在接受到数据库文件数据后，将其存盘并加载到内存中</li>
<li>增量复制：master将所有收集到修改命令依次传给slave,完成同步</li>
<li>正常连接时是增量复制，重新连接master时是全量复制</li>
</ul>
<p>常见四种策略</p>
<ol>
<li><p>一仆二主</p>
<ul>
<li><p>一台主机，两台备机</p>
</li>
<li><p>主库关闭之后，从库依然还是slave从库，从库连接状态从up变为down</p>
</li>
<li><p>从库关闭后就与主库断开了，要想保持关系，得重新设置从库配置</p>
</li>
<li><p>主库挂了，从库原地待命</p>
</li>
</ul>
</li>
</ol>
<ol start="2">
<li>薪火相传</li>
</ol>
<ul>
<li><p>上一个slave可以是下一个slave的master,slave同样可以接受其他slaves的连接和同步请求</p>
</li>
<li><p>slave作为链条中的下一个数据库的master,可以有效减小一仆二主中主库的写压力</p>
</li>
<li><p>从库中途更改主库，从库会清除之前的数据，重新建立拷贝最新的数据</p>
</li>
</ul>
<ol start="3">
<li>反客为主</li>
</ol>
<ul>
<li><p>主库挂了，从库上位成为主库，其余从库可以指向新主库</p>
</li>
<li><p>从库上位指令：slaveof no one</p>
</li>
</ul>
<ol start="4">
<li><p>哨兵模式(sentinel)</p>
<ul>
<li><p>反客为主的自动版，自动监测主库是否故障，如果故障了将根据投票数自动将从库转换为主库</p>
</li>
<li><p>使用步骤：</p>
<p>1.调整结构，一仆二主</p>
<p>2.自定义创建sentinel.conf文件，名字必须正确</p>
<p>3.配置哨兵，填写内容</p>
<p>Sentinel monitor 被监控数据库名字 127.0.0.1(主库ip) 6379(主库端口) 1</p>
<p>数字1表示主机挂掉后slave投票看让谁接替成为主机，得票数多少后成为主机</p>
<p>4.启动哨兵</p>
<p>Redis-sentinel /myredis/sentinel.conf</p>
<p>原主库如果重启连接会成为新主库的从库，哨兵模式可以同时监控多个主库</p>
</li>
</ul>
</li>
</ol>
<pre><code>复制延时：

由于所有的写操作都是现在master上操作，然后同步更新到slave上，所以同步需要时间，slave获取数据有延迟

系统繁忙，slave机器数量增加都会增加复制延时</code></pre></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">李上</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/04/02/redis/">http://yoursite.com/2020/04/02/redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">定不辱使命</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a><a class="post-meta__tags" href="/tags/NOSQL/">NOSQL</a><a class="post-meta__tags" href="/tags/RDB/">RDB</a><a class="post-meta__tags" href="/tags/AOF/">AOF</a><a class="post-meta__tags" href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/">持久化</a><a class="post-meta__tags" href="/tags/%E9%94%81/">锁</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">数据类型</a></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/11/spring/"><img class="prev_cover lazyload" data-src="/img/spring.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/11/spring/" title="Spring学习笔记"><img class="relatedPosts_cover lazyload"data-src="/img/spring.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-11</div><div class="relatedPosts_title">Spring学习笔记</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 李上</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-sun-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js" ></script><script src="/js/utils.js" ></script><script src="/js/main.js" ></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>